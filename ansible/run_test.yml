- hosts: efus
  tasks:
    - name: start cspec pipeline
      shell: LD_LIBRARY_PATH=/opt/dm_group/usr/lib:../lib ./efu2 -d cspec -s 10 -b itest02.dm.esss.dk:9092 -a 192.168.12.11
      args:
        chdir: ~/output/bin
      async: 60
      poll: 0
      register: efu_pipeline

    - name: load cspec calibration
      shell: ./mgloadcal.py /home/jenkins/test-data/validruns_15
      args:
        chdir: ~/output/util/efushell

- hosts: epics-to-kafka-forwarders
  tasks:
    - name: start epics-to-kafka-forwarder
      shell: LD_LIBRARY_PATH=/opt/dm_group/usr/lib:./output/lib ./forward-epics-to-kafka --config-file config.json -v
      args:
        chdir: ~
      async: 60
      poll: 0

- hosts: file-writers
  tasks:
    - name: output NeXus file is absent
      file:
        path: ~/file-writer/output.h5
        state: absent

    - name: pv NeXus file is absent
      file:
        path: ~/file-writer/pv.h5
        state: absent

    - name: start file writer
      shell: LD_LIBRARY_PATH=/opt/dm_group/usr/lib ./kafka-to-nexus --broker-command //itest02.dm.esss.dk:9092
      args:
        chdir: ~/file-writer
      async: 60
      poll: 0

    - name: send command to start writing events to file
      shell: ./send-start-cmd.py "itest03.dm.esss.dk" "C-SPEC_detector" "c_spec_data" "output.h5"
      args:
        chdir: ~

    - name: send command to start writing an EPICS PV to file
      shell: ./send-pv.py "itest03.dm.esss.dk" "amor_sim" "SQ:AMOR:DIMETIX:DIST" "pv.h5"
      args:
        chdir: ~

- hosts: data-generators
  tasks:
    - name: start data generation
      shell: LD_LIBRARY_PATH=/opt/dm_group/usr/lib:../lib ./gencspecfile -f ../../test-data/cncs_10_13.bin -i 192.168.12.22
      args:
        chdir: ~/output/bin

- hosts: file-writers
  tasks:
    - name: change value of EPICS PV
      shell: pvput SQ:AMOR:DIMETIX:LASER ON; sleep 1; pvput SQ:AMOR:DIMETIX:SimVal 0; sleep 1; pvput SQ:AMOR:DIMETIX:SimVal 1; sleep 1; pvput SQ:AMOR:DIMETIX:SimVal 2; sleep 1

    - name: send stop command to file writer
      shell: ./send-stop-cmd.py "itest03.dm.esss.dk"
      args:
        chdir: ~

- hosts: epics-to-kafka-forwarders
  tasks:
    - name: kill epics-to-kafka-forwarder
      shell: pkill -9 forward-epics

# Check results
- hosts: efus
  tasks:
    - name: check cspec pipeline result
      async_status:
        jid: "{{ efu_pipeline.ansible_job_id }}"
      register: efu_pipeline_result
      until: efu_pipeline_result.finished
      retries: 30
      ignore_errors: yes

    - name: set playbook_result flag
      set_fact: playbook_result="success"

    - name: set playbook_result flag if task failed
      set_fact: playbook_result="failure"
      when: efu_pipeline_result.rc!=0

    - name: print task result
      debug:
        msg: "{{ efu_pipeline_result.stdout_lines }}"

- hosts: file-writers
  tasks:
    - name: check if NeXus file was generated
      shell: LD_LIBRARY_PATH=/opt/dm_group/usr/lib /opt/dm_group/usr/bin/h5ls output.h5
      args:
        chdir: ~/file-writer

- hosts: efus
  tasks:
    - name: check playbook result
      fail:
        msg: playbook failed
      when: playbook_result=="failure"
